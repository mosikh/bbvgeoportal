<!doctype html>
<html lang="en">

<head>

<meta charset="utf-8">
<title></title>

<link rel="stylesheet" type="text/css" href="../index.css">
<link rel="icon" href="../IFN_Header.png">

<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.0/jquery.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" integrity="sha384-JcKb8q3iqJ61gNV9KGb8thSsNjpSL0n8PARn9HuZOnIxN0hoP+VmmDGMN5t9UJ0Z" crossorigin="anonymous">
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js" integrity="sha384-B4gt1jrGC7Jh4AgTPSdUtOBvfO8shuf57BaghqFfPlYxofvL8/KUEfYiJOMMV+rV" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.3/Chart.min.js" integrity="sha512-s+xg36jbIujB2S2VKfpGmlC3T5V2TF3lY48DX7u2r9XzGzgPsa6wTpOQA7J9iffvdeBN0q9tKzRxVxw1JviZPg==" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@0.7.0"></script>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/css/bootstrap.min.css" rel="stylesheet"> 
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js" integrity="sha384-IQsoLXl5PILFhosVNubq5LC7Qb9DXgDA9i+tQ8Zj3iwWAwPtgFTxbJ8NT4GN1R8p" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/js/bootstrap.min.js" integrity="sha384-Atwg2Pkwv9vp0ygtn1JAojH0nYbwNJLPhwyoVbhoPwBhjQPR5VtM2+xf0Uwh9KtT" crossorigin="anonymous"></script>


<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script> 
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />


<link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
<script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script> 


<script src="https://unpkg.com/leaflet-sidebar"></script>
<link type="text/css" rel="stylesheet" href="https://unpkg.com/leaflet-sidebar/src/L.Control.Sidebar.css"/>
  

<script src="https://unpkg.com/leaflet.browser.print/dist/leaflet.browser.print.min.js"></script>

<script src="https://unpkg.com/leaflet.coordinates/dist/Leaflet.Coordinates-0.1.5.min.js"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.7.5/proj4.js"></script>
<script src="https://unpkg.com/proj4leaflet/src/proj4leaflet.js"></script> 
  
  
<script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />


<script src="https://unpkg.com/leaflet-measure/dist/leaflet-measure.de.js"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet-measure/dist/leaflet-measure.css" />


<script src="https://unpkg.com/leaflet.vectorgrid@latest/dist/Leaflet.VectorGrid.js"></script>
<script src="https://unpkg.com/leaflet.vectorgrid@latest/dist/Leaflet.VectorGrid.bundled.js"></script>


<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet-easybutton@2/src/easy-button.css">
<script src="https://cdn.jsdelivr.net/npm/leaflet-easybutton@2/src/easy-button.js"></script>


<script src="https://unpkg.com/leaflet-draw/dist/leaflet.draw.js"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet-draw/dist/leaflet.draw.css"/>


<script src="https://unpkg.com/@turf/turf"></script>
 

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

 
<!-- <script src="https://rawgithub.com/mylen/leaflet.TileLayer.WMTS/master/leaflet-tilelayer-wmts.js"></script> -->
<script src="../leaflet-tilelayer-wmts-src.js"></script>


<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/css/select2.min.css"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.min.js"></script>


<link rel="stylesheet" href="https://unpkg.com/leaflet-control-boxzoom/dist/leaflet-control-boxzoom.css" />
<script src="https://unpkg.com/leaflet-control-boxzoom/dist/leaflet-control-boxzoom.js"></script>


<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.10.3/dist/sweetalert2.all.min.js"></script>
<link rel='stylesheet' href='https://cdn.jsdelivr.net/npm/sweetalert2@11.10.3/dist/sweetalert2.min.css'></link>

</head>

<body>

<nav id="header" class="navbar navbar-expand-sm bg-success" style="height:5vh;background-color: #000080 !important;">
	<div class="container-fluid">
		<a class="navbar-brand">
			<img src="../IFN_Header.svg" width="80" height="80"  alt="">
			<span id="maptitle"></span>
		</a>
		<div class="collapse navbar-collapse justify-content-end" id="navbarNav">
			<ul class="navbar-nav">
				<li class="nav-item active">
					<a class="nav-link" href="/home">Projects<span class="sr-only">(current)</span></a>
				</li>
				<li class="nav-item">
					<a class="nav-link" href="#">Administration</a>
				</li>
				<li class="nav-item dropdown">
					<a class="nav-link dropdown-toggle" href="#" id="navbarDropdownMenuLink" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
						Settings
					</a>
					<div class="dropdown-menu dropdown-menu-right" aria-labelledby="navbarDropdownMenuLeft" style="overflow-y:auto;z-index:2000 !important">
						<a class="dropdown-item" href="#">Profile</a>
						<a class="dropdown-item" id="signout-btn" style="cursor:pointer;">Sign out</a>
					</div>
				</li>
			</ul>
		</div>
	</div>		
</nav>
		
<div id="map" class="row">
	<div id="coordinatesPanel">
		<div id="scale-container"></div>
		<div id="coord-container">
			<input type="text" id="coordLon" class="coordTextBox" readonly>
			<input type="text" id="coordLat" class="coordTextBox" readonly>
			<select id="coordSystem" >
				<option value="degrees" selected>Degrees</option>
				<option value="meters">Meters</option>
				<option value="dms">D.M.S.</option>
			</select>
		</div>
	</div>
	
	<div id="DropdownContainer">
		<div class="abookmark"><p>Locating</p><button onclick="closeLocater()" title="Close" class="close-btn"><i class="fas fa-times"></i></button></div>
		<div id="locateDropdown">
		</div>
	</div>
</div>




<div id="sidebar">
	<div class="tab" id="mainTab">
		<button class="tablinks" onclick="opentabs(event, 'Layers')" id="defaulttab">Layers</button>
		<button class="tablinks" onclick="opentabs(event, 'Information')">Information</button>
		<button class="tablinks" onclick="opentabs(event, 'Permalink')">Permalink</button>
		<button class="tablinks" onclick="opentabs(event, 'Projects')">Projects</button>
	</div>
	
	<div id="Layers" class="tabcontent">
		<div class="mainbox" id="layertree"></div>
		<hr class="line">
		<p class style="margin-bottom:10px;color:white;font-weight:bold;">Base Layers</p>
		<select id="basetiles" onchange="changebase()"></select>
		<p style="margin-bottom:-5px;color:white;font-weight:bold;">Opacity</p>
		<div class="currentLevel"><span id="levelValue">100</span></div>
		<input type="range" id="basemapSlider" min="0" max="1" step="0.01" value="1"/>
		<div class="sliderLabels">
            <span>0</span>
            <span>100</span>
        </div>
	</div>
	
	<div id="Information" class="tabcontent">
		<div class="mainbox" id="infobox"></div>
	</div>

	<div id="Permalink" class="tabcontent">
		<div class="mainbox" id="linkbox">
			<div class="tab" style="padding-left:12px;padding-right:12px;padding-top:12px">
				<button class="permalinks" onclick="openPermatabs(event, 'Bookmarks')" id="defaultlink">Bookmarks</button>
				<button class="permalinks" onclick="openPermatabs(event, 'Share')">Share</button>
				<button class="permalinks" onclick="openPermatabs(event, 'Embed')">Embed</button>
			</div>
			<div id="Bookmarks" class="permacontent">
				<div class="permabox">
					<div>
						<input type="text" id="addBookmark" class="copyLinks" maxlength="20">
						<button onclick="addbookmark()" title="Add a bookmark"><i class="fas fa-plus"></i></button>
					</div>
				</div>
			</div>
			<div id="Share" class="permacontent">
				<div class="permabox">
					<input type="text" id="linkTextBox" class="copyLinks" readonly>
					<button onclick="copyLink(this)" value="linkTextBox"  title="Copy ..."><i class="fas fa-copy"></i></button>
				</div>
			</div>
			<div id="Embed" class="permacontent">
				<div class="permabox">
					<div>
						<select id="dropdown-content" onchange="handleDropdown()">
							<option value="small" selected>Small</option>
							<option value="medium">Medium</option>
							<option value="large">Large</option>
							<option value="customized">Customized</option>
						</select>
						<input type="text" id="frameWidth" class="frameDimention" value="900" onchange="handleTextboxChange(this)">
						<input type="text" id="frameHeight" class="frameDimention" value="700" onchange="handleTextboxChange(this)">
					</div>
					<div>
						<input type="text" id="frameTextBox" class="copyLinks" readonly>
						<button onclick="copyLink(this)" value="frameTextBox" title="Copy ..."><i class="fas fa-copy"></i></button>
					</div>
				</div>
			</div>
			
		</div>
	</div>
	
	
	
	<div id="Projects" class="tabcontent">
		<div class="mainbox" id="projectbox">
			<input type="text" onkeyup="searchProject()" id="projectInput" placeholder="Search a project...">
			<table id="projectTable">
			</table>
		</div>
	</div>
</div>



<div id="custom-panels">
	<div id="layerPanel" class="custom-panel">
		<div class="abookmark"><p>Layer Information</p><button onclick="closePanel()" title="Close" class="close-btn"><i class="fas fa-times"></i></button></div>
		<div class="mainbox" style="margin-top:-5px;">
			<h4>Name</h4>
			<p id="panelName"></p>
			<h4>Type</h4>
			<p id="panelType"></p>
			<h4>Zoom to layer extent</h4>
			<button onclick="zoomPanel()" title="Zoom ..."><i class="fas fa-search-plus"></i></button>
			<div id="opacityToHide">
				<h4 id="opacity-panel">Opacity</h4>
				<div class="currentLevel"><span id="levelValuePanel">100</span></div>
				<input type="range" id="opacitySlider" min="0" max="1" step="0.01" value="1" />
				<div class="sliderLabels">
					<span>0</span>
					<span>100</span>
				</div>
			</div>
		</div>
	</div>
</div>



<script>
// The loading message
document.addEventListener('DOMContentLoaded', function () {
  // Show SweetAlert loading message
	Swal.fire({
		icon: "info",
		title: 'Loading Data',
		html: 'Please wait while we load the data...',
		allowOutsideClick: false,
		showConfirmButton: false
	});
	
});
//-----------------------------------------------------------------------------------

const pathSegments = window.location.pathname.split('/');
const mainProject = pathSegments[pathSegments.length - 2];
const QGISProject = pathSegments.pop();

//-----------------------------------------------------------------------------------


// Map creation and qgs loading
var domain = "http://localhost:3000"
//var domain = "https://bbvnewgeoportal.onrender.com"


var qgs;
$.ajax({
	type: "GET",
    url: domain+'/'+mainProject+'/'+QGISProject+'/getQgsData',
    dataType: "json",
	async: false,
	success: function(data){
        qgs = data;                
    },
	error: function() {
        console.log('Error in AJAX request');
    }
});


var conf;
$.ajax({
	type: "GET",
    url: domain+'/'+mainProject+'/'+QGISProject+'/getQgsConf',
    dataType: "json",
	async: false,
	success: function(data){
        conf = data;                
    },
	error: function() {
        console.log('Error in AJAX request');
    }
});
//---------------------------------------------------------------------------------------------------
// Scale convertion to zoom level and calculate the min and max zoom level based on scale
function calculateZoomLevel(scale, tileSize = 256, screenDpi = 96) {
    // Constants for Leaflet and Earth
    const earthRadius = 6378137; // Earth radius in meters

    // Calculate the ground resolution at zoom level 0
    const initialResolution = 2 * Math.PI * earthRadius / tileSize;

    // Calculate the zoom level based on the desired scale
    const zoomLevel = Math.log2(initialResolution / (scale * 0.0254 / screenDpi));

    // Round the zoom level to the nearest integer
    const roundedZoom = Math.round(zoomLevel);

    // Ensure the zoom level is within Leaflet's limits
    return Math.max(0, Math.min(roundedZoom, 18));
}

var maxScale = conf.options.minScale;
var minScale = conf.options.maxScale;
var maximumZoom = calculateZoomLevel(maxScale);
var minimumZoom = calculateZoomLevel(minScale);

//---------------------------------------------------------------------------------------
//Set the initial map extent and zoom level

var projection = conf.options.projection.proj4;
var wgsProjection = '+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs';
var wgsCoordinates_first = proj4(projection, wgsProjection, conf.options.initialExtent.slice(0, 2));
var wgsCoordinates_second = proj4(projection, wgsProjection, conf.options.initialExtent.slice(2, 4));
var initial_bbox = [(wgsCoordinates_first.slice(1,2).concat(wgsCoordinates_first.slice(0,1))), (wgsCoordinates_second.slice(1,2).concat(wgsCoordinates_second.slice(0,1)))]

var map = L.map('map',{maxZoom: maximumZoom,minZoom: minimumZoom}).setView([49.510208, 9.312286], minimumZoom);
map.fitBounds(initial_bbox);
///----------------------------------------------------------------------------------------------------- 

// Zoom to initial map extent 
var initialBtn = L.easyButton({
    states: [{
		icon: "fa-solid fa-maximize",
        title: 'Zoom to initial map extent',      
		position: 'topright',
		id: 'iniButton',
        onClick: function() {       
            map.fitBounds(initial_bbox);
        }       
    }]
});

if (!("hideNavbar" in conf.options) || (conf.options.hideNavbar == "False")){
	initialBtn.addTo(map);
}
///-----------------------------------------------------------------------------------------------------
// Rectangle Zoom
if (!("hideNavbar" in conf.options) || (conf.options.hideNavbar == "False")){
	L.Control.boxzoom({ position:'topleft' }).addTo(map);
}

///-----------------------------------------------------------------------------------------------------
// Hide +- Default Zoom
if (("hideNavbar" in conf.options) || (conf.options.hideNavbar == "True")){
	var zoomControl = document.querySelector('.leaflet-control-zoom');
	if (zoomControl) {
		zoomControl.parentNode.removeChild(zoomControl);
	}
}

///----------------------------------------------------------------------------------------------------- 
// Set the title of the map
var servertitle = qgs.elements[1].elements[16].elements[42].elements[0]["text"]
var element = document.getElementById("maptitle");
element.innerText = servertitle;

//------------------------------------------------------------------------------------------------------
// Title of the HTML project
var mainProject_decoded = mainProject.replace(new RegExp("%20", 'g'), " ");
document.title = servertitle+" - "+mainProject_decoded+" - BBV Deutschland";
//-----------------------------------------------------------------------------------

// Basemap opacity slider
var baseSlider = document.getElementById('basemapSlider');
var levelValue = document.getElementById('levelValue');

baseSlider.addEventListener('input', function() {
    levelValue.textContent = Math.round((baseSlider.value)*100);
});

var absololute_dir;
$.ajax({
	type: "GET",
    url: domain+'/directoryPath',
    dataType: "json",
	async: false,
	success: function(data){
        absololute_dir = data;                
    },
	error: function() {
        console.log('Error in AJAX request');
    }
});

// Base layers
var absololute_dir = absololute_dir['dir'];
var qgisUrl = 'http://localhost:9000/cgi-bin/qgis_mapserv.fcgi.exe?MAP='+absololute_dir+'/'+mainProject+'/'+QGISProject+'.qgs';
//var qgisUrl = 'http://localhost:9000/cgi-bin/qgis_mapserv.fcgi.exe?MAP=C:/Users/mkheyrollahi/Downloads/221103-BBVPlanauskunftServer-v3.qgs';
var base_layers = {};


Object.entries(conf.layers).forEach(([k,v]) => {
	if ((v.baseLayer == "True") && (v.type == "layer")){
		var matchFound = false;
		for (var u = 0; u < qgs.elements[1].elements[16].elements[50].elements[1].elements.length; u++) {
			if (qgs.elements[1].elements[16].elements[50].elements[1].elements[u].elements[0].text == v.id){
				baseRaster = new L.TileLayer.WMTS(qgisUrl,{
					layer: v.name,
					format: 'image/png',
					transparent: true,
					tilematrixSet: "EPSG:3857"
				});
				base_layers[v.title] = baseRaster;
				$("#basetiles").append('<option value="'+v.title+'">'+v.title+'</option>');
				if (conf.options.startupBaselayer == k){
					currentbase = baseRaster;
					baseRaster.addTo(map);
					$("#basetiles").val(v.title);
				}
				matchFound = true;
				break;
			}
		}
		if (!matchFound) {
			document.addEventListener('DOMContentLoaded', function () {
				Swal.update({
					icon: "error",
					title: 'Error in WMTS settings of basemaps',
					html: 'Please contact your administrator.',
				}); 
			});
			throw new Error();
		}
	}
});


if (conf.options.emptyBaselayer == "True"){
	$("#basetiles").append('<option value="empty">No Base map</option>');
	base_layers['empty'] = '';
}


if (conf.options.startupBaselayer == "empty"){
	currentbase = base_layers['empty'];
	$("#basetiles").val("empty");
}

let baseOpaCollection = {};
function changebase(){
	let baseclick = document.getElementById("basetiles").value
	if (currentbase != ''){
		map.removeLayer(currentbase);
	}
	if (baseclick != "empty"){
        map.addLayer(base_layers[baseclick]);
	}
	currentbase = base_layers[baseclick];
	
	// Basemap opacity slider
	if (currentbase != ''){
		if (typeof baseOpaCollection[currentbase['options']['layers']] !== 'undefined') {
			baseSlider.value = baseOpaCollection[currentbase['options']['layers']];
			levelValue.textContent = Math.round((baseSlider.value)*100);
		}else{
			baseSlider.value = 1;
			levelValue.textContent = 100;
		}
	}else{
		baseSlider.value = 0;
		levelValue.textContent = 0;
	}
}

// Basemap opacity slider
baseSlider.addEventListener('input', function() {
	if (currentbase != ''){
		var opacityBase = baseSlider.value;
		currentbase.setOpacity(opacityBase);
		baseOpaCollection[currentbase['options']['layers']] = opacityBase;
	}
});

//---------------------------------------------------------------------------------------------
// Hide navbar
$(document).ready(function() {
	if (("hideHeader" in conf.options) && (conf.options.hideHeader == "True")){
		$('#header').hide();
		$('#map').css('height', '100vh');
	}
});
//---------------------------------------------------------------------------------------------

// Sidebar
var sidebar = L.control.sidebar('sidebar', {
            closeButton: false,
            position: 'left'
        });
		
if (!("hideLegend" in conf.options) || (conf.options.hideLegend == "False")){
	map.addControl(sidebar);
	setTimeout(function () {
            sidebar.show();
    }, 500);
}
//--------------------------------------------------------------------------------------------
//Print option

function addLeadingZero(value) {
	return value < 10 ? '0' + value : value;
}

var customActionToPrint = function(context, mode) {
	return function() {
		Swal.fire({
			html:
				'<h4 class="swal2-title">Einzelheiten zum Druck</h4>' +
				'<input id="printTopic" class="swal2-input" placeholder="Thema" value="Planauskunft">' +
				'<input id="printTicketnummer" class="swal2-input" placeholder="Ticketnummer">' +
				'<input id="printBeschreibung" class="swal2-input" placeholder="Beschreibung"></br></br>'+
				'<input type="checkbox" id="printCheckbox" checked> <label for="printCheckbox">Druckangaben einbeziehen?</label>',
			showCancelButton: true,
			confirmButtonText: "OK",
			cancelButtonText: 'Cancel',
			cancelButtonColor: "#00ffff",
			confirmButtonColor: "#000080",
		})
		.then((result) => {
			if (result.isConfirmed) {
				var printCheckbox = document.getElementById('printCheckbox');
				if (printCheckbox.checked) {
					var textTopic = document.getElementById("printTopic").value;
					var textTicketnummer = document.getElementById("printTicketnummer").value;
					var textBeschreibung = document.getElementById("printBeschreibung").value;
					var currentDate = new Date();

					// Get the components of the date and time
					var year = currentDate.getFullYear();
					var month = currentDate.getMonth() + 1; // Months are zero-indexed
					var day = currentDate.getDate();
					var hours = currentDate.getHours();
					var minutes = currentDate.getMinutes();
					var seconds = currentDate.getSeconds();

					// Format the date and time as a string
					var formattedDateTime = year + '-' + addLeadingZero(month) + '-' + addLeadingZero(day) +
											' ' + addLeadingZero(hours) + ':' + addLeadingZero(minutes);
						
					var printText = '<div class="sub-content" leaflet-browser-print-content><table><tr><td rowspan="3"><img src="../IFN_Header.png"></td>';
					printText += '<td rowspan="3"><h4>'+textTopic+'</h4></td>';
					printText += '<td><p>Ticketnummer: '+textTicketnummer+'</p></td></tr>';
					printText += '<tr><td><p>Beschreibung: '+textBeschreibung+'</p></td></tr>';
					printText += '<tr><td><p>Stand: '+formattedDateTime+'</p></td></tr></table></div>';
					$('body').append(printText);
				}
				context._printMode(mode);
			}
		});
		if (printCheckbox.checked) {
			$('body .sub-content').remove();
		}
	}
};

options ={
	position: 'topleft', 
	title: 'Drucken ...',
		printModes: [         
			L.BrowserPrint.Mode.Landscape("A4",{title: "Querformat", margin:0, action: customActionToPrint, invalidateBounds: true}), 
			L.BrowserPrint.Mode.Portrait("A4",{title: "Hochformat", margin:0, action: customActionToPrint, invalidateBounds: true}), 		
			L.BrowserPrint.Mode.Auto("A4",{title: "Automatisch", margin:0, action: customActionToPrint, invalidateBounds: true}), 		
			L.BrowserPrint.Mode.Custom("A4",{title: "Benutzerdefiniert", margin:0, action: customActionToPrint, invalidateBounds: true}),
		],
	}
if (("print" in conf.options) && (conf.options.print == "True")){
	L.control.browserPrint(options).addTo(map);
}

L.BrowserPrint.Utils.registerLayer(L.TileLayer, 'L.TileLayer', function (layers) {
    return L.tileLayer.wms(layers._url, layers.options);
});
//---------------------------------------------------------------------------------------

//based on WMS
async function fetchData(url) {
	return new Promise((resolve, reject) => {
		$.ajax({
			url: url,
			dataType: 'json',
			success: function (data) {
				resolve(data);
			},
			error: function (xhr, status, error) {
				//reject(new Error(`AJAX error! Status: ${status}, Error: ${error}`));
				console.log('WFS error')
				Swal.update({
					icon: "error",
					title: 'Error ...',
					html: 'The data could not be loaded. Please refresh your page. If it problem persists, please contact your administrator.',
				});
			}
		});
	});
}

var popupType = conf.options.popupLocation;
if (popupType == "minidock"){
	var popupContainer = L.DomUtil.create('div', 'mini-popup-container');
	$('#map').append(popupContainer);
}else if (popupType == "right-dock"){
	var popupContainer = L.DomUtil.create('div', 'right-popup-container');
	$('body').append(popupContainer);
}else if (popupType == "bottomdock"){
	var popupContainer = L.DomUtil.create('div', 'bottom-popup-container');
	$('#map').append(popupContainer);
}else if (popupType == "dock"){
	var popupContainer = L.DomUtil.create('div', 'left-popup-container');
	var leftButtonPopup = $("<button class='tablinks'>Pop Up</button>");
	leftButtonPopup.on('click', function(event) {
		opentabs(event, 'POPUPS');
	});
	$('#mainTab').append(leftButtonPopup);
	$('#sidebar').append('<div id="POPUPS" class="tabcontent"><div class="mainbox" id="popupBox"></div></div>');
	$('#popupBox').append(popupContainer);
}


// Define the click event handler function
function createSidePopup(content) {
    return function () {
		if (popupType == "right-dock"){
			$('#map').css('width', '80%');
		}else if (popupType == "bottomdock"){
			$('#sidebar').css('height', '72%');
			$('.bottom-popup-container').on('wheel', function (event) {
				event.stopPropagation();
			});
		}else if (popupType == "dock"){
			leftButtonPopup.click();
		}else if (popupType == "minidock"){
			$('.mini-popup-container').on('wheel', function (event) {
				event.stopPropagation();
			});
		}
		popupContainer.innerHTML = content;
		popupContainer.style.display = 'block';
    };
}

function isMapWithinBounds(title) {
	var layerBounds = updated_bbox[title];
    var mapBounds = map.getBounds();
    return mapBounds.intersects(layerBounds);
}


async function visualization(title, geometryType, toggle, layerName, response, grouped, popup, id) {
	maplayers[title] = []
	
	if (grouped == "ungrouped"){
		var minzoom = minimumZoom;
	}else {
		var minzoom = maximumZoom - 3;
		var currentZoom = map.getZoom();
		if (currentZoom < minzoom){
			opacity =1
		}else{
			opacity =0
		}
		map.on('zoomend', function () {
			currentZoom = map.getZoom();
			if (currentZoom < minzoom) {
				opacity =1;
			} else {
				opacity =0;
			}
			return opacity;
		});
			
		
		if (geometryType == "line"){
			var polylineLayer = L.geoJSON(response);
			updated_bbox[title] = polylineLayer.getBounds();
			var polylineCluster = L.markerClusterGroup({
				spiderfyOnMaxZoom: true,
				showCoverageOnHover: false,
				zoomToBoundsOnClick: true,
				removeOutsideVisibleBounds: true,
				maxClusterRadius: 200,
				maxClusterSize: 200,
				disableClusteringAtZoom: minzoom,
				iconCreateFunction: function () {
					return L.divIcon({html: '<br>' + '<div style="text-align:center;opacity:'+opacity+'"><a>' + title + '</a></div>', className: 'mycluster', iconSize: L.point(30, 30) });
				},

			});
			polylineLayer.eachLayer(layer => {
				var latlngs = layer.getLatLngs(); // Get polyline coordinates
				var polyline = L.polyline(latlngs, { color: 'red' }); // Create a new polyline
				var center = polyline.getBounds().getCenter(); // Get the center of the polyline
				var marker = L.marker(center, { icon: L.divIcon({ className: 'leaflet-div-icon' }), opacity:0 });
				polylineCluster.addLayer(marker); // Add the marker to the cluster group
			});
			
			if ((toggle == "checked")&(isMapWithinBounds(title))){
				polylineCluster.addTo(map);
			}	
			maplayers[title].push(polylineCluster);
		}else if (geometryType == "polygon"){
			var polygonLayer = L.geoJSON(response);
			updated_bbox[title] = polygonLayer.getBounds();
			var polygonCluster = L.markerClusterGroup({
				spiderfyOnMaxZoom: true,
				showCoverageOnHover: false,
				zoomToBoundsOnClick: true,
				removeOutsideVisibleBounds: true,
				maxClusterRadius: 200,
				maxClusterSize: 200,
				disableClusteringAtZoom: minzoom -1,
				iconCreateFunction: function () {
					return L.divIcon({html: '<br>' + '<div style="text-align:center;opacity:'+opacity+'"><a>' + title + '</a></div>', className: 'mycluster', iconSize: L.point(30, 30) });
				},

			});
			
			polygonLayer.eachLayer(layer => {
				var centroid = turf.centroid(layer.toGeoJSON().geometry);
				var marker = L.marker([centroid.geometry.coordinates[1], centroid.geometry.coordinates[0]], { icon: L.divIcon({ className: 'leaflet-div-icon' }), opacity:0 })
				polygonCluster.addLayer(marker);
			});
			
			if ((toggle == "checked")&(isMapWithinBounds(title))){
				map.addLayer(polygonCluster);
			}
			
			maplayers[title].push(polygonCluster);
			
			var minzoom = minzoom -1;
			
		}else if (geometryType == "point"){
			if (popup == ""){
				var pointlayer = L.geoJSON(response,{
					pointToLayer: function (feature, latlng) {
					hpstyle = {
						radius: 0.5,
						weight: 0.01,
						opacity: 0,
						fillOpacity: 0
					};

					return L.circleMarker(latlng, hpstyle);
					}
				});
				updated_bbox[title] = pointlayer.getBounds();
				var markers = L.markerClusterGroup({
					spiderfyOnMaxZoom: true,
					showCoverageOnHover: false,
					zoomToBoundsOnClick: true,
					removeOutsideVisibleBounds: true,
					disableClusteringAtZoom: minzoom
				});
				markers.addLayer(pointlayer);
				if ((toggle == "checked")&(isMapWithinBounds(title))){
					map.addLayer(markers);
				}
				
				maplayers[title].push(markers);
			}
		}
	}
	
	if (popup !== ""){
		first_Zindex -= 1;
		map.createPane('pane:'+first_Zindex).style.zIndex = first_Zindex;
		var popopPanel = L.geoJSON(WFSs[title], {
		// Define popup content based on feature properties
			pointToLayer: function (feature, latlng) {
				if (geometryType === "point") {
					return L.circleMarker(latlng, {
						opacity: 0,
						fillOpacity: 0,
						bubblingMouseEvents: false
					});
				}
			},
			style: function (feature) {
				if (geometryType !== "point") {
					return {
						opacity: 0,
						fillOpacity: 0
					};
				}
			},
			onEachFeature: function (feature, layer) {
				layer.options.pane = 'pane:'+first_Zindex;
				if (popup == 'auto'){
					var tableContent = '<table>';
					tableContent += '<thead>';
					tableContent += '<tr><th>Field</th><th>Value</th></tr>';
					tableContent += '</thead>';
					tableContent += '<tbody>';
					for (var prop in feature.properties) {
						if (feature.properties.hasOwnProperty(prop)) {
							tableContent += '<tr><th>' + prop + '</th><td>' + feature.properties[prop] + '</td></tr>';
						}
					}
					tableContent += '</tbody>';
					tableContent += '</table>';
				} else {
					var popupCopy = popup;
					for (var prop in feature.properties) {
						if (feature.properties.hasOwnProperty(prop)) {
							var placeholder = '[% "' + prop + '" %]';
							var value = feature.properties[prop];
							popupCopy = popupCopy.replace(placeholder, value);
						}
					}
					var tableContent = popupCopy;
				}
				
				var popupContent = '<div class="popupHeader">' +
                       '<p>'+title+'</p><button title="Close" onclick="closePopup()"><i class="fas fa-times"></i></button></div><div class="popupTable">' +tableContent +'</div>';
					   
				if (popupType == "map"){
					layer.bindPopup(popupContent, {
						maxWidth: 'auto',
					})
				}else{
					layer.on('click', createSidePopup(popupContent));
				}
			}
		});
		updated_bbox[title] = popopPanel.getBounds();
		if (geometryType == "point"){
			var markers = L.markerClusterGroup({
				spiderfyOnMaxZoom: true,
				showCoverageOnHover: false,
				zoomToBoundsOnClick: true,
				removeOutsideVisibleBounds: true,
				disableClusteringAtZoom: minzoom
			});
			markers.addLayer(popopPanel);
			maplayers[title].push(markers);
			if ((toggle == "checked")&(isMapWithinBounds(title))){
				map.addLayer(markers);
			}
		}else{
			maplayers[title].push(popopPanel);
			if ((toggle == "checked")&(isMapWithinBounds(title))){
				popopPanel.addTo(map);
			}
		}
	}
	if (!(title in updated_bbox)){
		updated_bbox[title] = L.geoJSON(WFSs[title]).getBounds();
	}

	var matchFound = false;
	for (var t = 0; t < qgs.elements[1].elements[16].elements[50].elements[1].elements.length; t++) {
		if (qgs.elements[1].elements[16].elements[50].elements[1].elements[t].elements[0].text == id){
			
			first_Zindex -= 1;
			var raster = new L.TileLayer.WMTS(qgisUrl, {
				layer: layerName,
				tilematrixSet: "EPSG:3857",
				format: "image/png",
				transparent: true,
				minZoom: minzoom,
				maxZoom: 18,
				zIndex: first_Zindex,
			});
			
			if ((toggle == "checked")&(isMapWithinBounds(title))){
				raster.addTo(map);
			}
			maplayers[title].push(raster);
			
			matchFound = true;
			break;
		}
	}
	
	if (!matchFound) {
		Swal.update({
			icon: "error",
			title: 'Error in WMTS settings',
			html: 'Please contact your administrator.',
		});
		throw new Error();
	}
}


function closePopup(){
	if ((popupType == "map")||(popupType == "dock")){
	}else{
		if (popupType == "right-dock"){
			$('#map').css('width', '100%');
		}else if (popupType == "bottomdock"){
			$('#sidebar').css('height', '100%');
		}
		popupContainer.style.display = 'none';
	}
}


function findValue(dictionary, targetValue) {
	for (const key in dictionary) {
		if (dictionary[key].id === targetValue) {
			return key;
		}
	}
	return null;
}

var first_Zindex = 300;
let maplayers = {};
let WFSs = {};
let updated_bbox = {};

async function processNestedDict(qgis_obj,nr,Parent){
	return new Promise(async (resolve, reject) => {
		try{
			var obj = qgis_obj.elements[5].elements;
		}catch(error){
			var obj = qgis_obj;
		}	
		for (var key in obj) {
			var position = nr + 1;
			var parent = Parent;
			if (parent == "Null"){
				var parent = "#layertree";
			}else{
				var parent = "#"+parent+"_div"
			}
			var margin = position * 10;
			if (obj[key]["name"] == "layer-tree-layer"){ 
				var id = obj[key]["attributes"]["id"];
				var name = findValue(conf.layers, id);
				var title = conf.layers[name].title;
				if (conf.layers[name].baseLayer == "False"){
					if (conf.layers[name].displayInLegend == "True"){
						var geometryType = conf.layers[name].geometryType;
						if (conf.layers[name].toggled == "True"){
							var toggle = "checked";
						} else {
							var toggle = "";
						}
						
						if (conf.layers[name].groupAsLayer == "True"){
							var grouped = "grouped";
						}else {
							var grouped = "ungrouped";
						}
						
						var popup = "";
						if (conf.layers[name].popup == "True"){
							if (conf.layers[name].popupSource == 'auto'){
								var popup = conf.layers[name].popupSource;
							}else if (conf.layers[name].popupSource == 'qgis'){
								for (var p = 0; p < qgs.elements[1].elements[14].elements.length; p++) {
									if (qgs.elements[1].elements[14].elements[p].elements[2].elements[0].text == id){
										var popup = qgs.elements[1].elements[14].elements[p].elements.pop().elements[0].text;
									}
								}
							}
						}
						
						var matchFound = false;
						for (var r = 0; r < qgs.elements[1].elements[16].elements[17].elements.length; r++) {
							if (qgs.elements[1].elements[16].elements[17].elements[r].elements[0].text == id){
								var thisURL = domain+'/'+mainProject+'/'+QGISProject+'/getWFS/'+name;
								var response = await fetchData(thisURL);
								WFSs[title] = response;
								await visualization (title, geometryType, toggle, name, response, grouped, popup, id);
								matchFound = true;
								break;
							}
						}
						if (!matchFound) {
							Swal.update({
								icon: "error",
								title: 'Error in WFS settings',
								html: 'Please contact your administrator.',
							});
						}
						
						if ((obj[key].elements[0].elements[0].elements) && (obj[key].elements[0].elements[0].elements[0]["attributes"]["name"] == "showFeatureCount")){
							var count = response.features.length;
							var count = '['+count+']';
						}else{
							var count = "";
						}
						$(parent).append('<div class="inline-container"><span onclick="collapse(this)" id="'+title+'" class="triangle right" style="margin-left:'+margin+'px;"></span><input type="checkbox" class="check" id="'+title+'" data-check-id="'+title+'" value ="'+Parent+'" onchange="toggleLayer(this);" '+toggle+'><p class="sidebar-layer" data-panel-id="'+title+'" onclick="panelClick(this)">'+title+' '+count+'</p></div>')
						var legend = qgisUrl+'&SERVICE=WMS&REQUEST=GetLegendGraphic&LAYERS='+name+'&ITEMFONTSIZE=9&SYMBOLWIDTH=4&SYMBOLHEIGHT=4&LAYERTITLE=False&RULELABEL=AUTO&ITEMFONTFAMILY=Times New Roman';
						var legend = legend.replace(new RegExp(" ", 'g'), "%20");
						var legend_margin = margin + 20;
						$(parent).append('<div style="margin-left:'+legend_margin+'px;" id="'+title+'_div" class="legend"><img src='+legend+'></div>');
						
					}else if (name in conf.locateByLayer){
						var thisURL = domain+'/'+mainProject+'/'+QGISProject+'/getWFS/'+name;
						var response = await fetchData(thisURL);
						WFSs[title] = response;
					}
				}

			} else if (obj[key]["name"] == "layer-tree-group") {
				var groupName = obj[key]["attributes"]["name"];
				if ((conf.layers[groupName].baseLayer == "False") && (conf.layers[groupName].displayInLegend == "True")){		
					if (conf.layers[groupName].toggled == "True"){
						var toggle = "checked";
					}else {
						var toggle = "";
					}
					$(parent).append('<div class="inline-container"><span onclick="collapse(this)" id="'+groupName+'" class="triangle" style="margin-left:'+margin+'px;"></span><input type="checkbox" id="'+groupName+'" value ="'+Parent+'" class="groupcheck" onchange="toggleGroup(this);" '+toggle+'><p class="sidebar-group" data-panel-id="'+groupName+'" onclick="panelClick(this)"><strong>'+groupName+'</strong></p></div>');
					$(parent).append('<div value="'+groupName+'_div" class="content" id="'+groupName+'_div">');
					await processNestedDict(obj[key]["elements"], position,groupName);
				}
			}	
		}
		$('.legend').hide();
		resolve(WFSs);
	});
};

var qgs_layers = qgs.elements[1]; //.elements[5].elements;
//processNestedDict(qgs_layers,0,"Null");
//--------------------------------------------------------------------------------------------

// Locater
var locater = document.getElementById('DropdownContainer');
locater.style.visibility = "hidden";

function closeLocater(){
	locater.style.visibility = "hidden";
}

var locateBtn = L.easyButton({
    states: [{
		icon: "fa-solid fa-magnifying-glass-location",
        title: 'Locate by attribute',      
		position: 'topright',
		id: 'locateButton',
        onClick: function() {       
            if (locater.style.visibility == "hidden") {
				locater.style.visibility = "visible";
            }else {
				locater.style.visibility = "hidden";
            }
        }       
    }]
});

async function fetchAndProcessLocateData() {
    try {
        var WFSs = await processNestedDict(qgs_layers, 0, "Null");
        
        if (Object.keys(conf.locateByLayer).length !== 0) {
            locateBtn.addTo(map);
			var selectIndex = 0;
			var locateBbox = {};
            Object.entries(conf.locateByLayer).forEach(([k, v]) => {
                var name = findValue(conf.layers, v['layerId']);
				var title = conf.layers[name].title;
				$('#locateDropdown').append('<select class="locateSelect" data-placeholder="' + title + '" onchange="handleLocating(this)"><option value=""></option></select>');
				var targetFieldName = v['fieldName'];					
				for (var i = 0; i < WFSs[title].features.length; i++) {
					var feature = WFSs[title].features[i];
					var fieldValue = feature.properties[targetFieldName];
					$("#locateDropdown select:eq(" + selectIndex + ")").append('<option value="' +fieldValue+ '" >' + fieldValue + '</option>');
					locateBbox[fieldValue] = feature.bbox;
				}
				selectIndex += 1;
            });
			$(document).ready(function () {
				$('.locateSelect').select2({
					allowClear: true
				});
			});
			function handleLocating(selectElement) {
				var selectedValue = selectElement.value;
				if (selectedValue !== '') {
					var featureBbox = locateBbox[selectedValue];
					var featureBbox = [[featureBbox[1], featureBbox[0]],[featureBbox[3], featureBbox[2]]];
					map.fitBounds(featureBbox);
				}
			}		
			window.handleLocating = handleLocating;
        }
		Swal.close();
    } catch (error) {
        console.error(error);
    }
}

fetchAndProcessLocateData();
//-----------------------------------------------------------------------------------------

// Show layers just when they are in the map extent
function updateLayersOnMouseMove() {
    //for (var title in updated_bbox) {
	Object.entries(updated_bbox).forEach(([title, v]) => {
		
        //var layerBounds = updated_bbox[title];
        var layers = maplayers[title];
        var thecheckbox = document.querySelector('[data-check-id="'+title+'"]');

        if (thecheckbox && thecheckbox.checked && isMapWithinBounds(title)) {
			if (!(map.hasLayer(layers))){
				for (var i = 0; i < layers.length; i++) {
					map.addLayer(layers[i]);
				}
			}
        } else {
            for (var i = 0; i < layers.length; i++) {
                map.removeLayer(layers[i]);
            }
        }
    });
}

// Event listener for map mousemove event
map.on('moveend', updateLayersOnMouseMove);

//-----------------------------------------------------------------------------------------
// Layer tree function

function toggleLayer(box) {
	var boxId = box.id;
	var layer = maplayers[boxId];
	if ((box.checked)&& (isMapWithinBounds(boxId))) {
		for (var i=0; i < layer.length; i++) {
			map.addLayer(layer[i]);
		}
	} else {
		for (var i=0; i < layer.length; i++) {
			map.removeLayer(layer[i]);
		}
	}
}

function toggleGroup(group) {
	var groupId = group.id;
	var controlledCheckboxes = document.querySelectorAll('[value="'+groupId+'"]');

	controlledCheckboxes.forEach(function(box) {
		box.checked = group.checked;
		if (box.classList == "check"){
			toggleLayer(box);
		} else if (box.classList == "groupcheck"){
			toggleGroup(box);
		}
	});
}


function collapse(tri) { 
	const triangleId = tri.id;
	const subset = document.getElementById(triangleId + '_div');

	if (subset.style.display == "none") {
		subset.style.display = "block";
		tri.classList.remove('right');
	} else {
		subset.style.display = "none";
		tri.classList.toggle('right');	
	}
}


//--------------------------------------------------------------------------

// Tabs Management
function opentabs(evt, tabName) {
	// Declare all variables
	var i, tabcontent, tablinks;

	// Get all elements with class="tabcontent" and hide them
	tabcontent = document.getElementsByClassName("tabcontent");
	for (i = 0; i < tabcontent.length; i++) {
		tabcontent[i].style.display = "none";
	}

	// Get all elements with class="tablinks" and remove the class "active"
	tablinks = document.getElementsByClassName("tablinks");
	for (i = 0; i < tablinks.length; i++) {
		tablinks[i].className = tablinks[i].className.replace(" active", "");
	}

	// Show the current tab, and add an "active" class to the button that opened the tab
	document.getElementById(tabName).style.display = "block";
	evt.currentTarget.className += " active";
}

document.getElementById("defaulttab").click();

function openPermatabs(evt, tabName) {
	// Declare all variables
	var i, tabcontent, tablinks;

	// Get all elements with class="permacontent" and hide them
	tabcontent = document.getElementsByClassName("permacontent");
	for (i = 0; i < tabcontent.length; i++) {
		tabcontent[i].style.display = "none";
	}

	// Get all elements with class="permalinks" and remove the class "active"
	tablinks = document.getElementsByClassName("permalinks");
	for (i = 0; i < tablinks.length; i++) {
		tablinks[i].className = tablinks[i].className.replace(" active", "");
	}

	// Show the current tab, and add an "active" class to the button that opened the tab
	document.getElementById(tabName).style.display = "block";
	evt.currentTarget.className += " active";
}

document.getElementById("defaultlink").click();


//--------------------------------------------------------------------------
//measureControl
L.Control.Measure.include({
	// Method to set the icon on the capture marker
	_setCaptureMarkerIcon: function () {
		// Disable autopan on focus for the capture marker
		this._captureMarker.options.autoPanOnFocus = false;

		// Set the icon using a custom div icon
		this._captureMarker.setIcon(
			L.divIcon({
				iconSize: this._map.getSize().multiplyBy(2) // Adjust the icon size if needed
			})
		);
	},
});
options={
	position: 'topleft',
	primaryLengthUnit: 'meters', 
	secondaryLengthUnit: 'miles',
	activeColor: '#000080',
	completedColor: '#000080',
	popupOptions: { className: 'leaflet-measure-resultpopup', autoPanPadding: [10, 10] },
}

var measureControl = new L.Control.Measure(options);
if (("measure" in conf.options) && (conf.options.measure == "True")){
	measureControl.addTo(map);
};
//--------------------------------------------------------------------------

// Draw button

var drawbtn = L.easyButton({
    states: [{ 
		icon: "fa-solid fa-compass-drafting",
		title:     'Draw ...',      
		position: 'topleft',
		id: 'dwbtn',
		onClick: function() {
			var drawer = document.getElementById('the-draw-control');
			if (drawer.style.display === 'none') {
				drawer.style.display = "block";
			}else {
				drawer.style.display = "none";
			}
		}       
    }]
});

if (("draw" in conf.options) && (conf.options.draw == "True")){
	drawbtn.addTo(map);
}



var editableLayers = new L.FeatureGroup();
map.addLayer(editableLayers);
    
var MyCustomMarker = L.Icon.extend({
	options: {
		shadowUrl: null,
		iconAnchor: new L.Point(12, 12),
		iconSize: new L.Point(24, 24),
		iconUrl: 'https://upload.wikimedia.org/wikipedia/commons/thumb/8/88/Map_marker.svg/512px-Map_marker.svg.png'
	}
});

var options = {
	position: 'topleft',
	draw: {
		polyline: {
			shapeOptions: {
				color: '#000080',
				clickable: true,
				weight: 10
			}
		},
		polygon: {
			allowIntersection: true, // Restricts shapes to simple polygons
			drawError: {
				color: '#e1e100', // Color the shape will turn when intersects
				message: '<strong>Oh snap!<strong> you can\'t draw that!' // Message that will show when intersect
			},
			shapeOptions: {
				clickable: true,
				color: '#000080'
			}
		},
		circle: {
			shapeOptions: {
				clickable: true,
				color: '#000080'
			}
		},
		
		rectangle: {
			shapeOptions: {
				clickable: true,
				color: '#000080'
			}
		},
		marker: {
			icon: new MyCustomMarker()
		}
	},
	edit: {
		featureGroup: editableLayers, //REQUIRED!!
		remove: true
	}
};

var drawControl = new L.Control.Draw(options);
map.addControl(drawControl);

drawControl._container.id = 'the-draw-control';

var drawer = document.getElementById('the-draw-control');
drawer.style.display = "none";

map.on(L.Draw.Event.CREATED, function (e) {
	var type = e.layerType,
		layer = e.layer;
	editableLayers.addLayer(layer);
});

//---------------------------------------------------------------------

//Geolocation
options ={
	collapsed: false,
	errorMessage: "Nothing found...",
	showResultIcons: true,
	geocoder: new L.Control.Geocoder.Nominatim(),
	suggestMinLength: 3,
	queryMinLength: 1,
	position:"topright",
}
if (("geolocation" in conf.options) && (conf.options.geolocation == "True") && ("externalSearch" in conf.options)){
	var geocoder = L.Control.geocoder(options).addTo(map);
};

//------------------------------------------------------------------------------------------

//Coordinates panel
var coordinatesPanel = document.getElementById('coordinatesPanel');
coordinatesPanel.style.visibility = "hidden";

var coordControl = new L.Control.Coordinates({decimals: 6});
if (!("hideOverview" in conf.options) || (conf.options.hideOverview == "False")){
	coordControl.addTo(map);
	coordinatesPanel.style.visibility = "visible";
	var coordElement = document.querySelector('.leaflet-control-coordinates');
    coordElement.style.visibility = "hidden";
}

var LatTextbox = document.getElementById('coordLat');
var LngTextbox = document.getElementById('coordLon');


function convertToDMS(coord) {
	var absoluteCoord = Math.abs(coord);
	var degrees = Math.floor(absoluteCoord);
	var minutes = Math.floor((absoluteCoord - degrees) * 60);
	var seconds = ((absoluteCoord - degrees - minutes / 60) * 3600).toFixed(1);
  
	return degrees + '° ' + minutes + "' " + seconds + '"';
}

if (!("hideOverview" in conf.options) || (conf.options.hideOverview == "False")){
	map.on('mousemove', function (e) {
	  // Manually update the HTML content of the coordinates control
		
		var formattedCoordinates = L.Util.template(coordControl.options.labelTemplateLat + '<br>' + coordControl.options.labelTemplateLng, {
			x: L.NumberFormatter.round(e.latlng.lng, coordControl.options.decimals),
			y: L.NumberFormatter.round(e.latlng.lat, coordControl.options.decimals),
		});

		coordControl._container.innerHTML = formattedCoordinates;
	  
		var dmsLat = convertToDMS(e.latlng.lat);
		var dmsLng = convertToDMS(e.latlng.lng);
	  
		proj4.defs("EPSG:4326", "+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs");
		proj4.defs("EPSG:25832", "+proj=utm +zone=32 +ellps=WGS84 +datum=WGS84 +units=m +no_defs");
	  
		var utm = proj4(proj4.defs('EPSG:4326'), proj4.defs('EPSG:25832'), [e.latlng.lng, e.latlng.lat]);

		var coordSystem = document.getElementById('coordSystem').value;
		if (coordSystem == 'degrees'){
			LngTextbox.value = L.Util.formatNum(e.latlng.lng, coordControl.options.decimals);
			LatTextbox.value = L.Util.formatNum(e.latlng.lat, coordControl.options.decimals);
		}else if (coordSystem == 'meters'){
			LngTextbox.value = utm[0].toFixed(2);
			LatTextbox.value = utm[1].toFixed(2);
		}else if (coordSystem == 'dms'){
			LngTextbox.value = dmsLng+"E";
			LatTextbox.value = dmsLat+"N";
		}
		
	});
}

//---------------------------------------------------------------------------------------------
//Scale bar
var scaleControl = L.control.scale({
	imperial: false,  // Display metric units instead of imperial
	maxWidth: 300    // Set the maximum width of the scale bar
});
if (!("hideOverview" in conf.options) || (conf.options.hideOverview == "False")){
	scaleControl.addTo(map);

	var scaleContainer = document.getElementById('scale-container');
	scaleContainer.appendChild(scaleControl.getContainer());
}
//---------------------------------------------------------------------------------------------

// Share tab

var currentURL = window.location.href;

document.getElementById('linkTextBox').value = currentURL;

  // Function to copy the link to the clipboard
function copyLink(button) {
	var textBox= button.value;
	var textBox = document.getElementById(textBox);

	textBox.select();
	textBox.setSelectionRange(0, 99999); // For mobile devices
	// Copy the text to the clipboard
	document.execCommand('copy');
}
//-----------------------------------------------------------------------------------------------

// Embed tab
var widthText = document.getElementById("frameWidth");
var heightText = document.getElementById("frameHeight");
widthText.style.visibility = "hidden";
heightText.style.visibility = "hidden";

var width = 400;
var height = 300;
document.getElementById('frameTextBox').value = '<iframe width="'+width+'" height="'+height+'" frameborder="0" style="border:0" src="'+currentURL+'" allowfullscreen></iframe>'


function handleDropdown() {
	var dropdownContent = document.getElementById("dropdown-content");
    var selectedValue = dropdownContent.value;
	if (selectedValue == "small"){
		widthText.style.visibility = "hidden";
		heightText.style.visibility = "hidden";
		var width = 400;
		var height = 300;
	}else if (selectedValue == "medium"){
		widthText.style.visibility = "hidden";
		heightText.style.visibility = "hidden";
		var width = 600;
		var height = 450;
	}else if (selectedValue == "large"){
		widthText.style.visibility = "hidden";
		heightText.style.visibility = "hidden";
		var width = 800;
		var height = 600;
	}else if (selectedValue == "customized"){
		widthText.style.visibility = "visible";
		heightText.style.visibility = "visible";
		var width = 900;
		var height = 700;
		width = parseInt(widthText.value) || width;
		height = parseInt(heightText.value) || height;
	}
	document.getElementById('frameTextBox').value = '<iframe width="'+width+'" height="'+height+'" frameborder="0" style="border:0" src="'+currentURL+'" allowfullscreen></iframe>'
}
heightText.addEventListener('input', handleDropdown);
widthText.addEventListener('input', handleDropdown);

//-----------------------------------------------------------------------------

//Bookmark Tab
let mark_bboxs = {}
let count = 0;
function addbookmark (){
	var bookmarktext = document.getElementById('addBookmark');
	if ((bookmarktext.value.trim() !== '')&&(count < 6)) {
		$("#Bookmarks .permabox").append('<div class="abookmark" id="'+bookmarktext.value+'"><p>'+bookmarktext.value+'</p><button value="'+bookmarktext.value+'" onclick="zoomMark(this)"  title="Zoom ..."><i class="fas fa-search-plus"></i></button><button value="'+bookmarktext.value+'" onclick="deleteMark(this)"  title="Delete ..."><i class="fas fa-trash"></i></button></div>');
		
		count += 1;
		
		const bounds = map.getBounds();
        var west = bounds.getWest();
        var south = bounds.getSouth();
        var east = bounds.getEast();
        var north = bounds.getNorth();
		mark_bboxs[bookmarktext.value] = [[south, west],[north, east]];
		bookmarktext.value = '';
	}
}

function deleteMark (btn){
	var btnVal = btn.getAttribute("value");
	var divToDelete = document.querySelector('.abookmark#'+btnVal);
	divToDelete.remove();
	count -= 1;
}

function zoomMark (btn){
	var btnVal = btn.getAttribute("value");
	map.fitBounds(mark_bboxs[btnVal]);
}
//----------------------------------------------------------------------------------
// Layer Info Panel
var layerPanel = document.getElementById('custom-panels');
layerPanel.style.display = 'none';
function closePanel(){
	layerPanel.style.display = 'none';
	var panelName = document.getElementById('panelName');
	var currentName = panelName.textContent;
	var layerDiv = document.querySelector('[data-panel-id="'+currentName+'"]');
	var layerDiv = layerDiv.parentNode;
	layerDiv.style.borderColor = "#FFFFFF";
}

var opacitySlider = document.getElementById('opacitySlider');
var levelValuePanel = document.getElementById('levelValuePanel');

opacitySlider.addEventListener('input', function() {
    levelValuePanel.textContent = Math.round((opacitySlider.value)*100);
});

let OpaCollection = {};

function panelClick(itm){
	var layerDiv = itm.parentNode;

	itmTitle = itm.getAttribute('data-panel-id');
	
	var panelName = document.getElementById('panelName');
	
	if (layerPanel.style.display == 'none'){
		layerPanel.style.display = 'block';
		layerDiv.style.borderColor = "#6495ED";
	}else if (itmTitle == panelName.textContent){
		layerPanel.style.display = 'none';
		layerDiv.style.borderColor = "#FFFFFF";
	}else{
		$(".inline-container").css("border-color", "#FFFFFF");
		layerDiv.style.borderColor = "#6495ED";
	}
	
	panelName.textContent  = itmTitle;
	itmClass = itm.className;
	
	var opacityLabel = document.getElementById('opacity-panel')
	if (itmClass == "sidebar-layer"){
		document.getElementById('panelType').textContent = "Layer";
		opacitySlider.style.visibility = "visible";
		document.getElementById('opacityToHide').style.visibility = "visible";
	
		function zoomPanel(){
			var itmBbox = WFSs[itmTitle]["bbox"];
			var itmBbox = [[updated_bbox[itmTitle]['_southWest']['lat'], updated_bbox[itmTitle]['_southWest']['lng']],[updated_bbox[itmTitle]['_northEast']['lat'], updated_bbox[itmTitle]['_northEast']['lng']]];
			map.fitBounds(itmBbox);
		}
		window.zoomPanel = zoomPanel;
		
		if (typeof OpaCollection[itmTitle] !== 'undefined') {
			opacitySlider.value = OpaCollection[itmTitle];
			levelValuePanel.textContent = Math.round((opacitySlider.value)*100);
		}else{
			opacitySlider.value = 1;
			levelValuePanel.textContent = 100;
		}
		itmlayers = maplayers[itmTitle];
		opacitySlider.addEventListener('input', function() {
			var opacityValue = opacitySlider.value
			for (var i=0; i < itmlayers.length; i++) {
				try	{
					itmlayers[i].setOpacity(opacityValue);
					OpaCollection[itmTitle] = opacityValue;
				}catch (error) {					
				}
			}
		});
		
	}else if (itmClass == "sidebar-group"){
		document.getElementById('panelType').textContent = "Group";
		
		opacitySlider.style.visibility = "hidden";
		document.getElementById('opacityToHide').style.visibility = "hidden";
		
		var itemDiv = document.getElementById(itmTitle+'_div');
		groupItmsbbox = [];
		
		function zoomPanel(){
			// Find all <p> tags within the div
			var paragraphs = itemDiv.querySelectorAll('p');
			if (paragraphs.length > 0){
				paragraphs.forEach(function(paragraph) {
					if (paragraph.className == "sidebar-layer"){
						var itmBbox = updated_bbox[paragraph.getAttribute('data-panel-id')];
						var itmBbox = [[itmBbox['_southWest']['lat'], itmBbox['_southWest']['lng']],[itmBbox['_northEast']['lat'], itmBbox['_northEast']['lng']]];
						//var itmBbox = [[itmBbox[1], itmBbox[0]],[itmBbox[3], itmBbox[2]]];
						groupItmsbbox.push(itmBbox)
					}
				});

				var unionBoundingBox = L.latLngBounds();
				groupItmsbbox.forEach(function(layerBbox) {
					var layerBounds = L.latLngBounds(layerBbox);
					unionBoundingBox.extend(layerBounds);
				});
				map.fitBounds(unionBoundingBox);
			}
		}
		window.zoomPanel = zoomPanel;	
	}
}



function updateSidePanelPosition() {
    var sidebarWidth = document.getElementById('sidebar').offsetWidth;
	var sidebarWidth = sidebarWidth + 65;
    layerPanel.style.left = sidebarWidth + 'px';
	
	var navHeight = document.getElementById('header').offsetHeight;
	var navHeight = navHeight + 14;
    layerPanel.style.top = navHeight + 'px';
}

  // Call the function on page load and window resize
window.addEventListener('load', updateSidePanelPosition);
window.addEventListener('resize', updateSidePanelPosition);

//--------------------------------------------------------------------------------
// Projects tab
var projectsDict;
$.ajax({
	type: "GET",
    url: domain+'/projectsDict',
    dataType: "json",
	async: false,
	success: function(data){
        projectsDict = data;                
    },
	error: function() {
        console.log('Error in AJAX request');
    }
});

var projectsImg;
$.ajax({
	type: "GET",
    url: domain+'/projectsImg',
    dataType: "json",
	async: false,
	success: function(data){
        projectsImg = data;                
    },
	error: function() {
        console.log('Error in AJAX request');
    }
});


Object.entries(projectsDict).forEach(([key, value]) => {
	$("#projectTable").append('<tr class="projectHeader"><th><p>'+key+'</p></th></tr>');
	for (var h=0; h < value.length; h++) {
		valueLink = domain+'/'+key+'/'+value[h];
		imgName = projectsImg[key][h];
		if (imgName !== ''){ 
			imgSource = "../"+key+"/"+imgName;
			imgSource = encodeURIComponent(imgSource);
		}else {
			imgSource = "../without.jpg";
		}
		
		var projectMainName;
		$.ajax({
			type: "GET",
			url: domain+'/'+key+'/'+value[h]+'/getQgsData',
			dataType: "json",
			async: false,
			success: function(data){
				projectMainName = data;                
			},
			error: function() {
				console.log('Error in AJAX request');
			}
		});
		var projectMainName = projectMainName.elements[1].elements[16].elements[42].elements[0]["text"];
		$("#projectTable").append('<tr><td><a href='+valueLink+' target="_blank"><img src='+imgSource+'></br><a>'+projectMainName+'</a></td></tr>');	
	}
});

function searchProject() {
	var input, filter, table, tr, td, i, txtValue;
	input = document.getElementById("projectInput");
	filter = input.value.toUpperCase();
	table = document.getElementById("projectTable");
	tr = table.getElementsByTagName("tr");

	for (i = 0; i < tr.length; i++) {
		if (tr[i].classList.contains('projectHeader')) {
			var headerVisible = false;

			// Check if there are visible child td elements
			for (var j = i + 1; j < tr.length && tr[j].classList.contains('projectHeader') === false; j++) {
				td = tr[j].getElementsByTagName("td")[0];
				if (td) {
					txtValue = td.textContent || td.innerText;
					if (txtValue.toUpperCase().indexOf(filter) > -1) {
						headerVisible = true;
						break;
					}
				}
			}

			// Set the display style based on the visibility of children
			tr[i].style.display = headerVisible ? '' : 'none';
		} else {
			// For non-header rows, handle visibility based on the search filter
			td = tr[i].getElementsByTagName("td")[0];
			if (td) {
				txtValue = td.textContent || td.innerText;
				tr[i].style.display = txtValue.toUpperCase().indexOf(filter) > -1 ? '' : 'none';
			}
		}
	}
}

//--------------------------------------------------------------------------------------
// Information tab

var QGISProject_decode = QGISProject.replace(new RegExp("%20", 'g'), " ");
var projectIdx = projectsDict[mainProject].indexOf(QGISProject_decode);
var infoImg = projectsImg[mainProject][projectIdx];

if (infoImg !== ''){ 
	var infoImgSource = "../"+mainProject+"/"+infoImg;
	var infoImgSource = encodeURIComponent(infoImgSource);
}else {
	var infoImgSource = "../without.jpg";
}
$('#infobox').append('<table><tr><td><img src='+infoImgSource+'></td></tr></table>');


$('#infobox').append('<h4>Title</h4>');
$('#infobox').append('<p>'+servertitle+'</p>');

var severAbstract = qgs.elements[1].elements[16].elements[40].elements[0]["text"];
var severAbstract = severAbstract.split('\n');
$('#infobox').append('<h4>Description</h4>');
severAbstract.forEach(function(line) {
	$('#infobox').append('<p>'+line+'</p>');
});

var projection = qgs.elements[1].elements[4].elements[0].elements[3].elements[0]["text"];
$('#infobox').append('<h4>Projection</h4>');
$('#infobox').append('<p>EPSG: '+projection+'</p>');

var minx = qgs.elements[1].elements[16].elements[30].elements[0].elements[0]["text"];
var miny = qgs.elements[1].elements[16].elements[30].elements[1].elements[0]["text"];
var maxx = qgs.elements[1].elements[16].elements[30].elements[2].elements[0]["text"];
var maxy = qgs.elements[1].elements[16].elements[30].elements[3].elements[0]["text"];
$('#infobox').append('<h4>Extent</h4>');
$('#infobox').append('<p>'+minx+', '+miny+', '+maxx+', '+maxy+'</p>');
//-------------------------------------------------------------------------------------

document.getElementById('signout-btn').addEventListener('click', () => {
    window.location.href = '/signout';
});


</script>





</body>


</html>